"""쿼리 확장 유틸리티: 검색 쿼리를 개선하여 유사도를 높입니다."""

from __future__ import annotations
from typing import List, Dict


# 금융 용어 동의어 및 관련어 사전
FINANCIAL_SYNONYMS = {
    "카드론": ["카드론", "장기카드대출", "카드 대출", "신용카드 대출", "카드론 한도", "카드론 금리"],
    "현금서비스": ["현금서비스", "현금 서비스", "Cash Advance", "현금 인출", "카드 현금서비스"],
    "한도": ["한도", "이용한도", "신용한도", "대출한도", "한도 조회", "한도 확인"],
    "금리": ["금리", "이자율", "이자", "금리율", "대출금리", "이자율"],
    "대출": ["대출", "융자", "차입", "대출금", "대출 상품"],
    "예금": ["예금", "적금", "저축", "예적금", "예금 상품"],
    "신용카드": ["신용카드", "카드", "신용 카드", "체크카드", "카드 상품"],
    "결제일": ["결제일", "결제 일자", "청구일", "납부일", "결제 날짜"],
    # RAG Score 개선을 위한 추가 키워드
    "카드값": ["결제대금", "청구금액", "카드대금", "이번달 카드값"],
    "연회비": ["연회비", "연회비 환불", "연회비 면제", "연회비 납부", "연회비 두 번"],
    "포인트": ["포인트", "포인트 현금화", "포인트 전환", "마일리지 전환", "포인트 조회"],
    "자동이체": ["자동이체", "자동납부", "재출금", "미납", "재출금 날짜", "자동이체 등록"],
    "할부": ["할부", "무이자", "할부 수수료", "리볼빙", "할부개월", "무이자할부"],
}

# ============================================================
# 구어체 → 문어체 매핑 (RAG Score 개선)
# ============================================================
# 사용자가 일상적으로 사용하는 구어체 표현을
# 문서에서 사용되는 공식적인 문어체 키워드로 매핑합니다.

COLLOQUIAL_TO_FORMAL: Dict[str, List[str]] = {
    # 카드 분실/도난 관련
    "잃어버렸": ["분실", "분실신고"],
    "잃어버림": ["분실", "분실신고"],
    "잃어버": ["분실"],
    "훔쳐": ["도난", "도난신고"],
    "훔쳐갔": ["도난", "도난신고"],
    "도둑맞": ["도난", "도난신고"],
    "없어졌": ["분실", "분실신고"],
    "안 보여": ["분실"],
    "못 찾겠": ["분실"],

    # 한도 관련 (limit_change 카테고리)
    "올리고": ["상향", "증액", "한도상향"],
    "올려": ["상향", "증액", "한도상향"],
    "높이고": ["상향", "증액"],
    "높여": ["상향", "증액"],
    "늘리고": ["상향", "증액", "한도증액"],
    "늘려": ["상향", "증액", "한도증액"],
    "줄이고": ["하향", "감액", "한도하향"],
    "줄여": ["하향", "감액", "한도하향"],
    "낮추고": ["하향", "감액"],
    "낮춰": ["하향", "감액"],
    "부족": ["초과", "한도초과", "한도부족"],
    "모자라": ["부족", "한도초과"],
    "복원": ["한도복원", "한도회복", "결제한도"],

    # 결제/납부 관련
    "빠지": ["출금", "결제", "인출"],
    "빠져": ["출금", "결제", "인출"],
    "나가": ["출금", "결제"],
    "나와": ["청구", "결제예정", "청구금액"],
    "얼마": ["금액", "조회", "확인"],
    "언제": ["일자", "날짜", "시기"],
    "언제 빠져": ["결제일", "출금일", "인출일"],

    # 정지/차단 관련
    "정지": ["정지", "차단", "사용중지"],
    "막아": ["차단", "정지"],
    "막혀": ["차단", "정지"],
    "풀어": ["해제", "해지"],
    "열어": ["해제", "활성화"],

    # 포인트 관련 (point_inquiry 카테고리)
    "쓰고": ["사용", "이용"],
    "써요": ["사용", "이용"],
    "쓸 수": ["사용", "이용"],
    "현금으로": ["현금화", "현금전환"],
    "현금화": ["현금전환", "포인트 현금화"],
    "마일리지": ["마일리지 전환", "포인트 전환"],
    "쌓였": ["적립", "누적", "적립포인트"],
    "쌓인": ["적립", "누적", "적립포인트"],
    "혜택": ["카드혜택", "할인혜택", "포인트혜택"],
    "캐시백": ["캐시백", "현금환급", "캐시백적립"],
    "유효기간": ["유효기간", "소멸예정", "포인트만료"],
    "할인": ["할인혜택", "할인율", "가맹점할인"],

    # 보이스피싱/사기 관련
    "당한": ["피해", "신고"],
    "당했": ["피해", "신고"],
    "사기": ["부정사용", "피싱", "사기피해"],

    # 연회비 관련 (annual_fee 카테고리)
    "두 번 빠짐": ["연회비 중복", "중복청구", "이중출금"],
    "두번 빠짐": ["연회비 중복", "중복청구"],
    "두 번 빠진": ["연회비 중복", "중복청구", "이중청구"],
    "포인트로 납부": ["포인트납부", "포인트결제"],
    "포인트로 낼": ["포인트납부", "포인트결제"],
    "돌려받": ["환불", "반환"],
    "첫해": ["첫해면제", "신규발급", "첫해연회비"],
    "면제": ["연회비면제", "면제조건", "면제혜택"],

    # 자동이체 관련
    "재출금": ["재출금", "재인출", "재결제"],
    "미납": ["미납", "연체", "미결제"],
    "다시 빠져": ["재출금", "재인출"],

    # 할부 관련
    "무이자": ["무이자할부", "무이자"],
    "이자 없이": ["무이자", "무이자할부"],
    "리볼빙": ["리볼빙", "일부결제금액이월약정"],

    # 일반 동사
    "하고 싶": ["신청", "요청"],
    "하려면": ["방법", "절차"],
    "어떻게": ["방법", "절차"],
    "알고 싶": ["조회", "확인", "안내"],
    "알려": ["안내", "조회"],
    "바꾸고": ["변경", "전환"],
    "바꿔": ["변경", "전환"],
}


def expand_query(query: str) -> str:
    """검색 쿼리를 확장하여 관련 키워드를 추가합니다.

    두 가지 확장을 수행합니다:
    1. 구어체 → 문어체 매핑: 일상 표현을 공식 용어로 변환
    2. 금융 용어 동의어 추가: 관련 금융 키워드 보충

    Args:
        query: 원본 검색 쿼리

    Returns:
        확장된 검색 쿼리 (원본 + 문어체 키워드 + 동의어)
    """
    expanded_terms: List[str] = []

    # 1단계: 구어체 → 문어체 변환 (BM25 키워드 매칭 강화)
    for colloquial, formal_terms in COLLOQUIAL_TO_FORMAL.items():
        if colloquial in query:
            expanded_terms.extend(formal_terms)

    # 2단계: 금융 용어 동의어 추가
    query_lower = query.lower()
    for keyword, synonyms in FINANCIAL_SYNONYMS.items():
        if keyword in query_lower:
            # 관련 동의어 중 상위 2개만 추가 (노이즈 방지)
            for synonym in synonyms[:2]:
                if synonym not in query_lower and synonym not in expanded_terms:
                    expanded_terms.append(synonym)

    # 중복 제거 및 원본 쿼리와 결합
    if expanded_terms:
        unique_terms = list(dict.fromkeys(expanded_terms))
        return f"{query} {' '.join(unique_terms)}"

    return query


def extract_keywords(query: str) -> List[str]:
    """쿼리에서 핵심 키워드를 추출합니다.
    
    Args:
        query: 검색 쿼리
        
    Returns:
        추출된 키워드 리스트
    """
    keywords = []
    query_lower = query.lower()
    
    for keyword in FINANCIAL_SYNONYMS.keys():
        if keyword in query_lower:
            keywords.append(keyword)
    
    return keywords

