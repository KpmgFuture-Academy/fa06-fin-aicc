# 🤖 WebSocket 상담원 이관 자동화 가이드

## ✨ 새로운 기능

**상담원 이관 리포트가 자동으로 생성됩니다!**

---

## 🔄 작동 방식

### 이전 (수동):
```
1. 사용자: "복잡한 문의..."
2. AI: "상담원이 필요합니다"
3. 사용자: "상담원 연결" 버튼 클릭 ← 수동!
4. 리포트 생성
5. 모달 표시
```

### 현재 (자동):
```
1. 사용자: "복잡한 문의..."
2. AI: "상담원이 필요합니다" (suggested_action: HANDOVER)
3. ✨ 시스템이 자동 감지!
4. ✨ 리포트 자동 생성!
5. ✨ 모달 자동 표시!
```

**사용자 액션 불필요!** 완전 자동화!

---

## 📊 WebSocket 메시지 플로우

### 1. 일반 채팅

```
브라우저                  WebSocket                백엔드
   │                         │                       │
   │  "안녕하세요"            │                       │
   │────────────────────────>│                       │
   │                         │  {"type": "message"}  │
   │                         │──────────────────────>│
   │                         │                       │
   │                         │  {"type": "processing"}
   │<────────────────────────│<──────────────────────│
   │  (로딩 표시)             │                       │
   │                         │                       │
   │                         │  LangGraph 실행중...   │
   │                         │                       │
   │                         │  {"type": "response"} │
   │<────────────────────────│<──────────────────────│
   │  "안녕하세요! 무엇을..."   │                       │
```

### 2. 상담원 이관 (자동) ✨

```
브라우저                  WebSocket                백엔드
   │                         │                       │
   │  "복잡한 문의..."        │                       │
   │────────────────────────>│──────────────────────>│
   │                         │                       │
   │                         │  Triage: HUMAN_REQUIRED
   │                         │                       │
   │                         │  {"type": "response"} │
   │<────────────────────────│<──────────────────────│
   │  "상담원이 도와..."       │    suggested_action:   │
   │                         │         HANDOVER      │
   │                         │                       │
   │                         │  ✨ 자동 감지!         │
   │                         │                       │
   │                         │  {"type": "handover_  │
   │                         │   processing"}        │
   │<────────────────────────│<──────────────────────│
   │  "리포트 생성 중..."      │                       │
   │                         │                       │
   │                         │  Summary Agent 실행   │
   │                         │  - 대화 요약          │
   │                         │  - 감정 분석          │
   │                         │  - 키워드 추출        │
   │                         │  - KMS 추천           │
   │                         │                       │
   │                         │  {"type": "handover_  │
   │                         │   report"}            │
   │<────────────────────────│<──────────────────────│
   │  ✨ 모달 자동 표시!       │                       │
   │                         │                       │
   │  ┌──────────────────┐  │                       │
   │  │ 상담원 이관 리포트 │  │                       │
   │  │ - 요약           │  │                       │
   │  │ - 감정: 😊       │  │                       │
   │  │ - 키워드         │  │                       │
   │  │ - 추천 문서      │  │                       │
   │  └──────────────────┘  │                       │
```

### 3. 상담원 이관 (수동) - "상담원 연결" 버튼

```
브라우저                  WebSocket                백엔드
   │                         │                       │
   │  "상담원 연결" 클릭      │                       │
   │────────────────────────>│                       │
   │                         │  {"type": "request_   │
   │                         │   handover"}          │
   │                         │──────────────────────>│
   │                         │                       │
   │                         │  (위와 동일한 프로세스) │
   │                         │                       │
   │  모달 표시               │                       │
   │<────────────────────────│<──────────────────────│
```

---

## 🎯 실제 사용 예시

### 예시 1: 간단한 문의

```
사용자: "대출 금리가 얼마인가요?"
    ↓
AI: "대출 금리는 연 3.5%~5.0%입니다..."
    suggested_action: CONTINUE
    ↓
✅ 일반 채팅 계속
```

### 예시 2: 복잡한 문의 (자동 이관)

```
사용자: "대출 연체 이자 계산 방법을 자세히 알려주세요"
    ↓
AI: "해당 문의는 상담사가 자세히 안내해드리겠습니다."
    suggested_action: HANDOVER ← 감지!
    ↓
✨ 시스템이 자동으로:
   1. 리포트 생성 시작
   2. 대화 이력 분석
   3. 요약 생성
   4. 감정 분석
   5. KMS 문서 추천
    ↓
✨ 모달 자동 표시:
   ┌─────────────────────────────────────┐
   │ 상담원 이관 리포트                    │
   ├─────────────────────────────────────┤
   │ 고객 감정: 😐 NEUTRAL                │
   │                                     │
   │ 요약:                               │
   │ - 대출 연체 이자 계산 방법 문의       │
   │ - 자세한 설명 요청                   │
   │                                     │
   │ 핵심 키워드:                         │
   │ 대출, 연체, 이자, 계산               │
   │                                     │
   │ 추천 문서:                           │
   │ 📄 대출 연체 관리 가이드 (95%)       │
   │ 📄 이자 계산 방법 안내 (88%)         │
   └─────────────────────────────────────┘
```

### 예시 3: 수동 이관 (버튼 클릭)

```
사용자: (대화 중) "상담원 연결" 버튼 클릭
    ↓
시스템: WebSocket으로 리포트 생성
    ↓
모달 표시 (위와 동일)
```

---

## 🔧 구현 세부사항

### 백엔드 (app/api/v1/chat.py)

```python
# 자동 감지
if response.suggested_action.value == "HANDOVER":
    logger.info(f"상담원 이관 감지 - 자동 리포트 생성 시작")
    
    # 리포트 생성 중 알림
    await manager.send_message(session_id, {
        "type": "handover_processing",
        "message": "상담원 연결을 준비하고 있습니다..."
    })
    
    # 리포트 생성
    handover_response = await process_handover(handover_request)
    
    # 전송
    await manager.send_message(session_id, {
        "type": "handover_report",
        "data": {...}
    })
```

### 프론트엔드 (App.tsx)

```typescript
// 상담원 리포트 핸들러
websocketService.onHandoverReport((report) => {
  console.log('상담원 리포트 자동 수신:', report);
  
  // HandoverResponse로 변환
  const handoverResponse = {
    status: report.status,
    analysis_result: {
      customer_sentiment: report.customer_sentiment,
      summary: report.summary,
      extracted_keywords: report.extracted_keywords,
      kms_recommendations: report.kms_recommendations
    }
  };
  
  // 모달 자동 표시
  setHandoverData(handoverResponse);
});
```

---

## 🎊 장점

### 1. 사용자 경험 개선
- ✅ 자동화: 버튼 클릭 불필요
- ✅ 빠름: 즉시 리포트 생성
- ✅ 직관적: 자연스러운 플로우

### 2. 상담원 효율성
- ✅ 즉시 정보 제공: 대기 시간 없음
- ✅ 정확한 컨텍스트: 대화 전체 요약
- ✅ 추천 문서: 관련 KMS 즉시 제공

### 3. 기술적 이점
- ✅ 실시간: WebSocket 양방향 통신
- ✅ 자동화: 수동 작업 제거
- ✅ 확장성: 향후 알림 기능 추가 용이

---

## 📝 테스트 방법

### 1. 일반 채팅 테스트

```
입력: "안녕하세요"
예상: AI 답변, 모달 없음
```

### 2. 자동 이관 테스트

```
입력: "상담원 연결해주세요"
예상: 
  1. AI 답변: "상담원이 연결됩니다..."
  2. 자동으로 모달 표시 ✨
  3. 리포트 내용 확인
```

### 3. 수동 이관 테스트

```
1. "상담원 연결" 버튼 클릭
2. 모달 자동 표시 ✨
3. 리포트 내용 확인
```

---

## 🚀 실행

구현이 완료되었습니다! 

**백엔드를 재시작**해주세요:

```bash
# 백엔드 터미널에서 Ctrl+C
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**프론트엔드도 재시작**:

```bash
# 프론트엔드 터미널에서 Ctrl+C
npm run dev
```

그런 다음 브라우저에서 테스트하세요!

