# ğŸ”„ WebSocket ì‘ë™ í”Œë¡œìš° ìƒì„¸ ì„¤ëª…

Bank AICC WebSocket ì–‘ë°©í–¥ í†µì‹  í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ ë° ì„¤ëª…

---

## ğŸ“Š ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ë¸Œë¼ìš°ì € (í´ë¼ì´ì–¸íŠ¸)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  React App (App.tsx)                                     â”‚   â”‚
â”‚  â”‚  - ì±„íŒ… ë©”ì‹œì§€ UI                                          â”‚   â”‚
â”‚  â”‚  - ìƒë‹´ì› ì—°ê²° ë²„íŠ¼                                         â”‚   â”‚
â”‚  â”‚  - ì—°ê²° ìƒíƒœ í‘œì‹œ (ğŸŸ¢ğŸŸ¡ğŸ”´ğŸ”µ)                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocket Service (websocket.ts)                        â”‚   â”‚
â”‚  â”‚  - ì—°ê²° ê´€ë¦¬                                               â”‚   â”‚
â”‚  â”‚  - ìë™ ì¬ì—°ê²° (ìµœëŒ€ 5íšŒ)                                   â”‚   â”‚
â”‚  â”‚  - Ping/Pong (30ì´ˆ)                                       â”‚   â”‚
â”‚  â”‚  - ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• WebSocket
        ws://localhost:8000/api/v1/chat/ws/{session_id}
                          â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI ë°±ì—”ë“œ (í¬íŠ¸ 8000)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocket Endpoint (chat.py)                            â”‚   â”‚
â”‚  â”‚  - ConnectionManager                                     â”‚   â”‚
â”‚  â”‚  - ë©”ì‹œì§€ ìˆ˜ì‹ /ì „ì†¡                                         â”‚   â”‚
â”‚  â”‚  - ìë™ ìƒë‹´ì› ë¦¬í¬íŠ¸ ìƒì„±                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Workflow Service (workflow_service.py)                  â”‚   â”‚
â”‚  â”‚  - LangGraph ì›Œí¬í”Œë¡œìš° ì‹¤í–‰                                â”‚   â”‚
â”‚  â”‚  - ìƒë‹´ì› ì´ê´€ ì²˜ë¦¬                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†•                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LangGraph Workflow                                      â”‚   â”‚
â”‚  â”‚  - Triage Agent (ì˜ë„ ë¶„ë¥˜)                                â”‚   â”‚
â”‚  â”‚  - RAG Search (ë¬¸ì„œ ê²€ìƒ‰)                                  â”‚   â”‚
â”‚  â”‚  - Answer Agent (ë‹µë³€ ìƒì„±)                                â”‚   â”‚
â”‚  â”‚  - Summary Agent (ìš”ì•½ ìƒì„±)                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•
        MySQL Database (í¬íŠ¸ 3306)
```

---

## ğŸ”„ í”Œë¡œìš° 1: WebSocket ì—°ê²° ìˆ˜ë¦½

### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
ë¸Œë¼ìš°ì €          WebSocket Service          FastAPI Backend
   â”‚                    â”‚                          â”‚
   â”‚  1. App ë¡œë“œ        â”‚                          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                    â”‚                          â”‚
   â”‚                    â”‚  2. connect(sessionId)   â”‚
   â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                    â”‚                          â”‚
   â”‚                    â”‚  3. WebSocket OPEN       â”‚
   â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                    â”‚                          â”‚
   â”‚                    â”‚  4. {"type": "status"}   â”‚
   â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                    â”‚                          â”‚
   â”‚  5. ìƒíƒœ ì—…ë°ì´íŠ¸    â”‚                          â”‚
   â”‚  (ğŸŸ¢ ì—°ê²°ë¨)       â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
```

### ìƒì„¸ ë‹¨ê³„

1. **ë¸Œë¼ìš°ì €**: React App ë¡œë“œ (`App.tsx`)
2. **useEffect ì‹¤í–‰**: WebSocket ì´ˆê¸°í™”
3. **WebSocket Service**: `connect(sessionId)` í˜¸ì¶œ
4. **FastAPI**: WebSocket ì—°ê²° ìˆ˜ë½ (`ConnectionManager.connect()`)
5. **FastAPI â†’ ë¸Œë¼ìš°ì €**: ì—°ê²° ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡
   ```json
   {
     "type": "status",
     "message": "connected",
     "session_id": "sess_xxx"
   }
   ```
6. **ë¸Œë¼ìš°ì €**: UI ì—…ë°ì´íŠ¸ (ğŸŸ¢ WebSocket ì—°ê²°)

---

## ğŸ”„ í”Œë¡œìš° 2: ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€

### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
ë¸Œë¼ìš°ì €    WebSocket     FastAPI    Workflow    LangGraph    DB
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚ 1. ë©”ì‹œì§€  â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚  ì…ë ¥     â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚ 2. send    â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚ 3. processing          â”‚            â”‚          â”‚
   â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚ 4. invoke â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚ 5. execute â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚ 6. result  â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚ 7. save    â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚ 8. response            â”‚          â”‚
   â”‚           â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚ 9. send    â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚            â”‚          â”‚
   â”‚           â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚ 10. í‘œì‹œ  â”‚            â”‚           â”‚            â”‚          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚           â”‚            â”‚          â”‚
```

### ìƒì„¸ ë‹¨ê³„

#### 1. ì‚¬ìš©ì ì…ë ¥ (ë¸Œë¼ìš°ì €)
- ì‚¬ìš©ìê°€ ì±„íŒ…ì°½ì— ë©”ì‹œì§€ ì…ë ¥
- `handleSendMessage()` í•¨ìˆ˜ í˜¸ì¶œ

#### 2. WebSocket ì „ì†¡ (websocket.ts)
```typescript
websocketService.sendMessage(userMessage);

// ì „ì†¡ ë°ì´í„°:
{
  "type": "message",
  "user_message": "ëŒ€ì¶œ ê¸ˆë¦¬ê°€ ì–¼ë§ˆì¸ê°€ìš”?"
}
```

#### 3. ì²˜ë¦¬ ì¤‘ ì•Œë¦¼ (FastAPI)
```json
{
  "type": "processing",
  "message": "ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
}
```

#### 4. ChatRequest ìƒì„± (FastAPI)
```python
request = ChatRequest(
    session_id=session_id,
    user_message=user_message
)
```

#### 5. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (workflow_service.py)
```python
response = await process_chat_message(request)
```

**ë‚´ë¶€ í”Œë¡œìš°**:
```
a. DBì—ì„œ ëŒ€í™” ì´ë ¥ ë¡œë“œ
    â†“
b. LangGraph ì›Œí¬í”Œë¡œìš° ì§„ì…
    â†“
c. Triage Agent
    - Intent Classification (ì˜ë„ ë¶„ë¥˜)
    - RAG Search (ë¬¸ì„œ ê²€ìƒ‰)
    - Decision Making (í‹°ì¼“ ë°œê¸‰)
    â†“
d. Answer Agent
    - ë‹µë³€ ìƒì„± (OpenAI GPT-4o-mini)
    - RAG ì»¨í…ìŠ¤íŠ¸ í™œìš©
    â†“
e. Chat DB Storage
    - ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
    - AI ì‘ë‹µ ì €ì¥
    - ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    â†“
f. GraphState â†’ ChatResponse ë³€í™˜
```

#### 6. WebSocket ì‘ë‹µ ì „ì†¡ (FastAPI)
```json
{
  "type": "response",
  "data": {
    "ai_message": "ëŒ€ì¶œ ê¸ˆë¦¬ëŠ” ì—° 3.5%~5.0%ì…ë‹ˆë‹¤...",
    "intent": "INFO_REQ",
    "suggested_action": "CONTINUE",
    "source_documents": [...]
  }
}
```

#### 7. ë¸Œë¼ìš°ì € ìˆ˜ì‹  (websocket.ts)
- `onMessage` í•¸ë“¤ëŸ¬ í˜¸ì¶œ
- `handleMessage()` â†’ `notifyMessage()` ì‹¤í–‰

#### 8. UI ì—…ë°ì´íŠ¸ (App.tsx)
```typescript
setMessages((prev) => [...prev, newMessage]);
```

---

## ğŸ”„ í”Œë¡œìš° 3: ìƒë‹´ì› ì´ê´€ ìë™í™” âœ¨ (NEW!)

### ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
ë¸Œë¼ìš°ì €    WebSocket     FastAPI    Workflow    Summary Agent    DB
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚ ì±„íŒ… ì¤‘   â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ response   â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ (HANDOVER) â”‚           â”‚              â”‚            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚ âœ¨ ìë™ ê°ì§€!            â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ handover_  â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ processing â”‚           â”‚              â”‚            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚ process_  â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚ handover()â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚  ìš”ì•½ ìƒì„±   â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚  ê°ì • ë¶„ì„   â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚  KMS ì¶”ì²œ    â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚  ê²°ê³¼ ë°˜í™˜   â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚  report   â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ handover_  â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚ report     â”‚           â”‚              â”‚            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚              â”‚            â”‚
   â”‚           â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚ ëª¨ë‹¬ í‘œì‹œ â”‚            â”‚           â”‚              â”‚            â”‚
   â”‚ (ë¦¬í¬íŠ¸)  â”‚            â”‚           â”‚              â”‚            â”‚
```

### ìƒì„¸ ë‹¨ê³„

#### ìë™ ìƒë‹´ì› ì´ê´€ (HANDOVER ê°ì§€ ì‹œ)

**1. AI ì‘ë‹µì—ì„œ HANDOVER ê°ì§€**
```json
{
  "type": "response",
  "data": {
    "ai_message": "ìƒë‹´ì‚¬ê°€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤...",
    "suggested_action": "HANDOVER"  â† ì´ê±¸ ê°ì§€!
  }
}
```

**2. ë°±ì—”ë“œê°€ ìë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ ìƒì„±**
```python
# app/api/v1/chat.py (WebSocket ì—”ë“œí¬ì¸íŠ¸)

if response.suggested_action.value == "HANDOVER":
    # ìë™ìœ¼ë¡œ ìƒë‹´ì› ë¦¬í¬íŠ¸ ìƒì„±
    handover_response = await process_handover(handover_request)
```

**3. ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì•Œë¦¼**
```json
{
  "type": "handover_processing",
  "message": "ìƒë‹´ì› ì—°ê²°ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
}
```

**4. Summary Agent ì‹¤í–‰**
- ì „ì²´ ëŒ€í™” ì´ë ¥ ìš”ì•½ (3ì¤„)
- ê³ ê° ê°ì • ë¶„ì„ (POSITIVE/NEGATIVE/NEUTRAL)
- í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
- KMS ë¬¸ì„œ ì¶”ì²œ

**5. ë¦¬í¬íŠ¸ ì „ì†¡**
```json
{
  "type": "handover_report",
  "data": {
    "status": "success",
    "customer_sentiment": "POSITIVE",
    "summary": "ê³ ê°ì´ ëŒ€ì¶œ ê¸ˆë¦¬ ë¬¸ì˜...",
    "extracted_keywords": ["ëŒ€ì¶œ", "ê¸ˆë¦¬", "ì‹ ì²­"],
    "kms_recommendations": [
      {
        "title": "ì£¼íƒë‹´ë³´ëŒ€ì¶œ ì•ˆë‚´",
        "url": "https://...",
        "relevance_score": 0.95
      }
    ]
  }
}
```

**6. ë¸Œë¼ìš°ì €ì—ì„œ ìë™ìœ¼ë¡œ ëª¨ë‹¬ í‘œì‹œ**
```typescript
websocketService.onHandoverReport((report) => {
  setHandoverData(report);  // ëª¨ë‹¬ ìë™ í‘œì‹œ
});
```

#### ìˆ˜ë™ ìƒë‹´ì› ì´ê´€ ("ìƒë‹´ì› ì—°ê²°" ë²„íŠ¼)

**1. ë²„íŠ¼ í´ë¦­**
```typescript
handleRequestHandover() â†’ websocketService.requestHandover()
```

**2. WebSocket ìš”ì²­ ì „ì†¡**
```json
{
  "type": "request_handover"
}
```

**3. ë°±ì—”ë“œ ì²˜ë¦¬** (ìœ„ì™€ ë™ì¼)

**4. ë¦¬í¬íŠ¸ ìˆ˜ì‹  ë° ëª¨ë‹¬ í‘œì‹œ**

---

## ğŸ“‹ ë©”ì‹œì§€ íƒ€ì… ì •ë¦¬

### í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„

| íƒ€ì… | ë°ì´í„° | ì„¤ëª… |
|------|--------|------|
| `message` | `{user_message: string}` | ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ |
| `request_handover` | - | ìˆ˜ë™ ìƒë‹´ì› ì´ê´€ ìš”ì²­ |
| `ping` | `{timestamp: number}` | ì—°ê²° ìœ ì§€ í™•ì¸ |

### ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸

| íƒ€ì… | ë°ì´í„° | ì„¤ëª… |
|------|--------|------|
| `status` | `{message: "connected"}` | ì—°ê²° ìƒíƒœ |
| `processing` | `{message: string}` | ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ |
| `response` | `{data: ChatResponse}` | AI ë‹µë³€ |
| `handover_processing` | `{message: string}` | ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ âœ¨ |
| `handover_report` | `{data: HandoverResponse}` | ìƒë‹´ì› ë¦¬í¬íŠ¸ âœ¨ |
| `handover_error` | `{message: string}` | ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜ âœ¨ |
| `error` | `{message: string}` | ì—ëŸ¬ ë©”ì‹œì§€ |
| `pong` | `{timestamp: number}` | Ping ì‘ë‹µ |

---

## ğŸ¯ ì£¼ìš” ê°œì„  ì‚¬í•­

### âœ¨ ìƒë‹´ì› ì´ê´€ ìë™í™”

#### ì´ì „ (HTTP):
```
1. AI ë‹µë³€: "ìƒë‹´ì›ì´ í•„ìš”í•©ë‹ˆë‹¤"
2. ì‚¬ìš©ì: "ìƒë‹´ì› ì—°ê²°" ë²„íŠ¼ í´ë¦­ â† ìˆ˜ë™!
3. HTTP POST /api/v1/handover/analyze
4. ë¦¬í¬íŠ¸ ìƒì„±
5. ëª¨ë‹¬ í‘œì‹œ
```

#### í˜„ì¬ (WebSocket):
```
1. AI ë‹µë³€: "ìƒë‹´ì›ì´ í•„ìš”í•©ë‹ˆë‹¤" (suggested_action: HANDOVER)
2. âœ¨ ë°±ì—”ë“œê°€ ìë™ ê°ì§€!
3. âœ¨ ë¦¬í¬íŠ¸ ìë™ ìƒì„±!
4. âœ¨ WebSocketìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡!
5. âœ¨ ëª¨ë‹¬ ìë™ í‘œì‹œ!
```

**ì‚¬ìš©ì ì•¡ì…˜ ë¶ˆí•„ìš”!** ì™„ì „ ìë™í™”! ğŸš€

---

## ğŸ” ìƒì„¸ ì½”ë“œ í”Œë¡œìš°

### 1. WebSocket ì—°ê²° (App.tsx)

```typescript
useEffect(() => {
  // ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
  websocketService.onMessage((response) => {
    addMessage('assistant', response.ai_message, response);
  });

  // ìƒë‹´ì› ë¦¬í¬íŠ¸ í•¸ë“¤ëŸ¬ âœ¨
  websocketService.onHandoverReport((report) => {
    setHandoverData(report);  // ëª¨ë‹¬ ìë™ í‘œì‹œ
  });

  // ì—°ê²°
  websocketService.connect(sessionId);
}, [sessionId]);
```

### 2. ë©”ì‹œì§€ ì „ì†¡ (websocket.ts)

```typescript
sendMessage(userMessage: string) {
  this.ws.send(JSON.stringify({
    type: 'message',
    user_message: userMessage
  }));
}
```

### 3. ë°±ì—”ë“œ ìˆ˜ì‹  ë° ì²˜ë¦¬ (chat.py)

```python
@router.websocket("/ws/{session_id}")
async def websocket_endpoint(websocket: WebSocket, session_id: str):
    while True:
        data = await websocket.receive_json()
        
        if data.get("type") == "message":
            # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
            response = await process_chat_message(request)
            
            # ì‘ë‹µ ì „ì†¡
            await manager.send_message(session_id, {
                "type": "response",
                "data": {...}
            })
            
            # âœ¨ HANDOVER ìë™ ê°ì§€
            if response.suggested_action.value == "HANDOVER":
                # ìë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ ìƒì„±
                handover_response = await process_handover(...)
                
                # ë¦¬í¬íŠ¸ ì „ì†¡
                await manager.send_message(session_id, {
                    "type": "handover_report",
                    "data": {...}
                })
```

### 4. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (workflow_service.py)

```python
async def process_chat_message(request: ChatRequest):
    # 1. DBì—ì„œ ì´ë ¥ ë¡œë“œ
    initial_state = chat_request_to_state(request)
    
    # 2. LangGraph ì‹¤í–‰
    workflow = get_workflow()
    final_state = await workflow.ainvoke(initial_state)
    
    # 3. ì‘ë‹µ ë³€í™˜
    response = state_to_chat_response(final_state)
    
    return response
```

### 5. ìƒë‹´ì› ì´ê´€ ì²˜ë¦¬ (workflow_service.py)

```python
async def process_handover(request: HandoverRequest):
    # 1. ëŒ€í™” ì´ë ¥ ë¡œë“œ
    conversation_history = session_manager.get_conversation_history(...)
    
    # 2. Summary Agent ì‹¤í–‰
    - ìš”ì•½ ìƒì„± (3ì¤„)
    - ê°ì • ë¶„ì„
    - í‚¤ì›Œë“œ ì¶”ì¶œ
    - KMS ë¬¸ì„œ ì¶”ì²œ
    
    # 3. HandoverResponse ë°˜í™˜
    return HandoverResponse(...)
```

---

## ğŸŠ ìµœì¢… ì‚¬ìš©ì ê²½í—˜

### ì‹œë‚˜ë¦¬ì˜¤: ë³µì¡í•œ ë¬¸ì˜ë¡œ ìƒë‹´ì› í•„ìš”

```
ì‚¬ìš©ì: "ëŒ€ì¶œ ì—°ì²´ ì´ì ê³„ì‚° ë°©ë²• ì¢€ ìì„¸íˆ ì•Œë ¤ì£¼ì„¸ìš”"
    â†“
AI: (Triage Agent ë¶„ì„) â†’ HUMAN_REQUIRED íŒë‹¨
    â†“
AI ë‹µë³€: "í•´ë‹¹ ë¬¸ì˜ëŠ” ìƒë‹´ì‚¬ê°€ ìì„¸íˆ ì•ˆë‚´í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. 
         ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
    â†“
âœ¨ ìë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘!
    â†“
ë¦¬í¬íŠ¸ ìƒì„± ì¤‘... (3-5ì´ˆ)
    â†“
âœ¨ ëª¨ë‹¬ ìë™ í‘œì‹œ!
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ìƒë‹´ì› ì´ê´€ ë¦¬í¬íŠ¸                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ê³ ê° ê°ì •: ğŸ˜Š NEUTRAL               â”‚
    â”‚                                     â”‚
    â”‚ ìš”ì•½:                               â”‚
    â”‚ - ëŒ€ì¶œ ì—°ì²´ ì´ì ê³„ì‚° ë°©ë²• ë¬¸ì˜      â”‚
    â”‚ - ìì„¸í•œ ì„¤ëª… ìš”ì²­                   â”‚
    â”‚                                     â”‚
    â”‚ í•µì‹¬ í‚¤ì›Œë“œ: ëŒ€ì¶œ, ì—°ì²´, ì´ì, ê³„ì‚°  â”‚
    â”‚                                     â”‚
    â”‚ ì¶”ì²œ ë¬¸ì„œ:                          â”‚
    â”‚ ğŸ“„ ëŒ€ì¶œ ì—°ì²´ ê´€ë¦¬ ê°€ì´ë“œ (95%)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ëª¨ë“  ê³¼ì •ì´ ìë™! ì‚¬ìš©ìëŠ” ì•„ë¬´ ë²„íŠ¼ë„ í´ë¦­í•˜ì§€ ì•ŠìŒ!** ğŸ‰

---

## ğŸ“Š ê°œì„  ì‚¬í•­ ë¹„êµ

| í•­ëª© | ì´ì „ (HTTP) | í˜„ì¬ (WebSocket) |
|------|-------------|------------------|
| **ì±„íŒ… í†µì‹ ** | HTTP ìš”ì²­/ì‘ë‹µ | WebSocket ì–‘ë°©í–¥ âœ¨ |
| **ìƒë‹´ì› ë¦¬í¬íŠ¸** | ë²„íŠ¼ í´ë¦­ í•„ìš” | ìë™ ìƒì„± âœ¨ |
| **ë¦¬í¬íŠ¸ í‘œì‹œ** | ìˆ˜ë™ ìš”ì²­ í›„ í‘œì‹œ | ìë™ ëª¨ë‹¬ í‘œì‹œ âœ¨ |
| **ì—°ê²°** | ë§¤ë²ˆ ìƒˆë¡œìš´ ì—°ê²° | ì—°ê²° ì¬ì‚¬ìš© âœ¨ |
| **ì‹¤ì‹œê°„ì„±** | ì—†ìŒ | ì„œë²„ í‘¸ì‹œ ê°€ëŠ¥ âœ¨ |

---

ì´ì œ êµ¬í˜„ì´ ì™„ë£Œë˜ì—ˆìœ¼ë‹ˆ í…ŒìŠ¤íŠ¸í•´ë³´ê² ìŠµë‹ˆë‹¤!

<function_calls>
<invoke name="read_lints">
<parameter name="paths">["app/api/v1/chat.py", "frontend/src/services/websocket.ts", "frontend/src/App.tsx"]
